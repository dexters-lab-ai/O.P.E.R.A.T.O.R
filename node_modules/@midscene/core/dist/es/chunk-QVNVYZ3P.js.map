{"version":3,"mappings":"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","names":["assert","language","PromptTemplate","content","getDebug","paddingToMatchBlock","call"],"ignoreList":[],"sources":["../../src/ai-model/service-caller/index.ts","../../src/ai-model/common.ts","../../src/ai-model/prompt/ui-tars-planning.ts","../../src/ai-model/prompt/assertion.ts","../../src/ai-model/prompt/llm-locator.ts","../../src/ai-model/prompt/llm-planning.ts","../../src/image/index.ts","../../src/ai-model/prompt/util.ts","../../src/ai-model/inspect.ts","../../src/ai-model/prompt/extraction.ts","../../src/ai-model/prompt/llm-section-locator.ts","../../src/ai-model/llm-planning.ts","../../src/ai-model/ui-tars-planning.ts"],"sourcesContent":["import { AIElementResponse, AIResponseFormat, type AIUsageInfo } from '@/types';\nimport { Anthropic } from '@anthropic-ai/sdk';\nimport {\n  DefaultAzureCredential,\n  getBearerTokenProvider,\n} from '@azure/identity';\nimport { assert, enableDebug, getDebug } from '@midscene/shared/utils';\nimport { ifInBrowser } from '@midscene/shared/utils';\nimport dJSON from 'dirty-json';\nimport OpenAI, { AzureOpenAI } from 'openai';\nimport type { ChatCompletionMessageParam } from 'openai/resources';\nimport { SocksProxyAgent } from 'socks-proxy-agent';\nimport {\n  ANTHROPIC_API_KEY,\n  AZURE_OPENAI_API_VERSION,\n  AZURE_OPENAI_DEPLOYMENT,\n  AZURE_OPENAI_ENDPOINT,\n  AZURE_OPENAI_KEY,\n  MIDSCENE_API_TYPE,\n  MIDSCENE_AZURE_OPENAI_INIT_CONFIG_JSON,\n  MIDSCENE_AZURE_OPENAI_SCOPE,\n  MIDSCENE_DEBUG_AI_PROFILE,\n  MIDSCENE_DEBUG_AI_RESPONSE,\n  MIDSCENE_LANGSMITH_DEBUG,\n  MIDSCENE_MODEL_NAME,\n  MIDSCENE_OPENAI_INIT_CONFIG_JSON,\n  MIDSCENE_OPENAI_SOCKS_PROXY,\n  MIDSCENE_USE_ANTHROPIC_SDK,\n  MIDSCENE_USE_AZURE_OPENAI,\n  MIDSCENE_USE_QWEN_VL,\n  MIDSCENE_USE_VLM_UI_TARS,\n  OPENAI_API_KEY,\n  OPENAI_BASE_URL,\n  OPENAI_MAX_TOKENS,\n  OPENAI_USE_AZURE,\n  getAIConfig,\n  getAIConfigInBoolean,\n  getAIConfigInJson,\n  vlLocateMode,\n} from '../../env';\nimport { AIActionType } from '../common';\nimport { assertSchema } from '../prompt/assertion';\nimport { locatorSchema } from '../prompt/llm-locator';\nimport { planSchema } from '../prompt/llm-planning';\n\nexport function checkAIConfig() {\n  if (getAIConfig(OPENAI_API_KEY)) return true;\n  if (getAIConfig(MIDSCENE_USE_AZURE_OPENAI)) return true;\n  if (getAIConfig(ANTHROPIC_API_KEY)) return true;\n\n  return Boolean(getAIConfig(MIDSCENE_OPENAI_INIT_CONFIG_JSON));\n}\n\nconst debugProfile = getDebug('ai:profile');\nconst debugCall = getDebug('ai:call');\n\nconst shouldPrintTiming = getAIConfigInBoolean(MIDSCENE_DEBUG_AI_PROFILE);\nlet debugConfig = '';\nif (shouldPrintTiming) {\n  console.warn(\n    'MIDSCENE_DEBUG_AI_PROFILE is deprecated, use DEBUG=midscene:ai:profile instead',\n  );\n  debugConfig = 'ai:profile';\n}\nconst shouldPrintAIResponse = getAIConfigInBoolean(MIDSCENE_DEBUG_AI_RESPONSE);\nif (shouldPrintAIResponse) {\n  console.warn(\n    'MIDSCENE_DEBUG_AI_RESPONSE is deprecated, use DEBUG=midscene:ai:response instead',\n  );\n  if (debugConfig) {\n    debugConfig = 'ai:*';\n  } else {\n    debugConfig = 'ai:call';\n  }\n}\nif (debugConfig) {\n  enableDebug(debugConfig);\n}\n\n// default model\nconst defaultModel = 'gpt-4o';\nexport function getModelName() {\n  let modelName = defaultModel;\n  const nameInConfig = getAIConfig(MIDSCENE_MODEL_NAME);\n  if (nameInConfig) {\n    modelName = nameInConfig;\n  }\n  return modelName;\n}\n\nasync function createChatClient({\n  AIActionTypeValue,\n}: {\n  AIActionTypeValue: AIActionType;\n}): Promise<{\n  completion: OpenAI.Chat.Completions;\n  style: 'openai' | 'anthropic';\n}> {\n  let openai: OpenAI | AzureOpenAI | undefined;\n  const extraConfig = getAIConfigInJson(MIDSCENE_OPENAI_INIT_CONFIG_JSON);\n\n  const socksProxy = getAIConfig(MIDSCENE_OPENAI_SOCKS_PROXY);\n  const socksAgent = socksProxy ? new SocksProxyAgent(socksProxy) : undefined;\n\n  if (getAIConfig(OPENAI_USE_AZURE)) {\n    // this is deprecated\n    openai = new AzureOpenAI({\n      baseURL: getAIConfig(OPENAI_BASE_URL),\n      apiKey: getAIConfig(OPENAI_API_KEY),\n      httpAgent: socksAgent,\n      ...extraConfig,\n      dangerouslyAllowBrowser: true,\n    }) as OpenAI;\n  } else if (getAIConfig(MIDSCENE_USE_AZURE_OPENAI)) {\n    const extraAzureConfig = getAIConfigInJson(\n      MIDSCENE_AZURE_OPENAI_INIT_CONFIG_JSON,\n    );\n\n    // https://learn.microsoft.com/en-us/azure/ai-services/openai/chatgpt-quickstart?tabs=bash%2Cjavascript-key%2Ctypescript-keyless%2Cpython&pivots=programming-language-javascript#rest-api\n    // keyless authentication\n    const scope = getAIConfig(MIDSCENE_AZURE_OPENAI_SCOPE);\n    let tokenProvider: any = undefined;\n    if (scope) {\n      assert(\n        !ifInBrowser,\n        'Azure OpenAI is not supported in browser with Midscene.',\n      );\n      const credential = new DefaultAzureCredential();\n\n      assert(scope, 'MIDSCENE_AZURE_OPENAI_SCOPE is required');\n      tokenProvider = getBearerTokenProvider(credential, scope);\n\n      openai = new AzureOpenAI({\n        azureADTokenProvider: tokenProvider,\n        endpoint: getAIConfig(AZURE_OPENAI_ENDPOINT),\n        apiVersion: getAIConfig(AZURE_OPENAI_API_VERSION),\n        deployment: getAIConfig(AZURE_OPENAI_DEPLOYMENT),\n        ...extraConfig,\n        ...extraAzureConfig,\n      });\n    } else {\n      // endpoint, apiKey, apiVersion, deployment\n      openai = new AzureOpenAI({\n        apiKey: getAIConfig(AZURE_OPENAI_KEY),\n        endpoint: getAIConfig(AZURE_OPENAI_ENDPOINT),\n        apiVersion: getAIConfig(AZURE_OPENAI_API_VERSION),\n        deployment: getAIConfig(AZURE_OPENAI_DEPLOYMENT),\n        dangerouslyAllowBrowser: true,\n        ...extraConfig,\n        ...extraAzureConfig,\n      });\n    }\n  } else if (!getAIConfig(MIDSCENE_USE_ANTHROPIC_SDK)) {\n    const baseURL = getAIConfig(OPENAI_BASE_URL);\n    if (typeof baseURL === 'string') {\n      if (!/^https?:\\/\\//.test(baseURL)) {\n        throw new Error(\n          `OPENAI_BASE_URL must be a valid URL starting with http:// or https://, but got: ${baseURL}\\nPlease check your config.`,\n        );\n      }\n    }\n\n    openai = new OpenAI({\n      baseURL: getAIConfig(OPENAI_BASE_URL),\n      apiKey: getAIConfig(OPENAI_API_KEY),\n      httpAgent: socksAgent,\n      ...extraConfig,\n      defaultHeaders: {\n        ...(extraConfig?.defaultHeaders || {}),\n        [MIDSCENE_API_TYPE]: AIActionTypeValue.toString(),\n      },\n      dangerouslyAllowBrowser: true,\n    });\n  }\n\n  if (openai && getAIConfigInBoolean(MIDSCENE_LANGSMITH_DEBUG)) {\n    if (ifInBrowser) {\n      throw new Error('langsmith is not supported in browser');\n    }\n    console.log('DEBUGGING MODE: langsmith wrapper enabled');\n    const { wrapOpenAI } = await import('langsmith/wrappers');\n    openai = wrapOpenAI(openai);\n  }\n\n  if (typeof openai !== 'undefined') {\n    return {\n      completion: openai.chat.completions,\n      style: 'openai',\n    };\n  }\n\n  // Anthropic\n  if (getAIConfig(MIDSCENE_USE_ANTHROPIC_SDK)) {\n    const apiKey = getAIConfig(ANTHROPIC_API_KEY);\n    assert(apiKey, 'ANTHROPIC_API_KEY is required');\n    openai = new Anthropic({\n      apiKey,\n      dangerouslyAllowBrowser: true,\n    }) as any;\n  }\n\n  if (typeof openai !== 'undefined' && (openai as any).messages) {\n    return {\n      completion: (openai as any).messages,\n      style: 'anthropic',\n    };\n  }\n\n  throw new Error('Openai SDK or Anthropic SDK is not initialized');\n}\n\nexport async function call(\n  messages: ChatCompletionMessageParam[],\n  AIActionTypeValue: AIActionType,\n  responseFormat?:\n    | OpenAI.ChatCompletionCreateParams['response_format']\n    | OpenAI.ResponseFormatJSONObject,\n): Promise<{ content: string; usage?: AIUsageInfo }> {\n  const { completion, style } = await createChatClient({\n    AIActionTypeValue,\n  });\n\n  const maxTokens = getAIConfig(OPENAI_MAX_TOKENS);\n\n  const startTime = Date.now();\n  const model = getModelName();\n  let content: string | undefined;\n  let usage: OpenAI.CompletionUsage | undefined;\n  const commonConfig = {\n    temperature: getAIConfigInBoolean(MIDSCENE_USE_VLM_UI_TARS) ? 0.0 : 0.1,\n    stream: false,\n    max_tokens:\n      typeof maxTokens === 'number'\n        ? maxTokens\n        : Number.parseInt(maxTokens || '2048', 10),\n    ...(getAIConfigInBoolean(MIDSCENE_USE_QWEN_VL) // qwen specific config\n      ? {\n          vl_high_resolution_images: true,\n        }\n      : {}),\n  };\n  if (style === 'openai') {\n    debugCall(`will send request to ${model}`);\n    const result = await completion.create({\n      model,\n      messages,\n      response_format: responseFormat,\n      ...commonConfig,\n    } as any);\n\n    debugProfile(\n      'model %s,%s usage %s, cost %s ms, requestId %s',\n      model,\n      vlLocateMode() ? ` ${vlLocateMode()},` : '',\n      JSON.stringify(result.usage),\n      Date.now() - startTime,\n      result._request_id,\n    );\n\n    assert(\n      result.choices,\n      `invalid response from LLM service: ${JSON.stringify(result)}`,\n    );\n    content = result.choices[0].message.content!;\n\n    debugCall(`response: ${content}`);\n    assert(content, 'empty content');\n    usage = result.usage;\n    // console.log('headers', result.headers);\n  } else if (style === 'anthropic') {\n    const convertImageContent = (content: any) => {\n      if (content.type === 'image_url') {\n        const imgBase64 = content.image_url.url;\n        assert(imgBase64, 'image_url is required');\n        return {\n          source: {\n            type: 'base64',\n            media_type: imgBase64.includes('data:image/png;base64,')\n              ? 'image/png'\n              : 'image/jpeg',\n            data: imgBase64.split(',')[1],\n          },\n          type: 'image',\n        };\n      }\n      return content;\n    };\n\n    const result = await completion.create({\n      model,\n      system: 'You are a versatile professional in software UI automation',\n      messages: messages.map((m) => ({\n        role: 'user',\n        content: Array.isArray(m.content)\n          ? (m.content as any).map(convertImageContent)\n          : m.content,\n      })),\n      response_format: responseFormat,\n      ...commonConfig,\n    } as any);\n    content = (result as any).content[0].text as string;\n    assert(content, 'empty content');\n    usage = result.usage;\n  }\n\n  return { content: content || '', usage };\n}\n\nexport async function callToGetJSONObject<T>(\n  messages: ChatCompletionMessageParam[],\n  AIActionTypeValue: AIActionType,\n): Promise<{ content: T; usage?: AIUsageInfo }> {\n  let responseFormat:\n    | OpenAI.ChatCompletionCreateParams['response_format']\n    | OpenAI.ResponseFormatJSONObject\n    | undefined;\n\n  const model = getModelName();\n\n  if (model.includes('gpt-4o')) {\n    switch (AIActionTypeValue) {\n      case AIActionType.ASSERT:\n        responseFormat = assertSchema;\n        break;\n      case AIActionType.INSPECT_ELEMENT:\n        responseFormat = locatorSchema;\n        break;\n      case AIActionType.EXTRACT_DATA:\n        //TODO: Currently the restriction type can only be a json subset of the constraint, and the way the extract api is used needs to be adjusted to limit the user's data to this as well\n        // targetResponseFormat = extractDataSchema;\n        responseFormat = { type: AIResponseFormat.JSON };\n        break;\n      case AIActionType.PLAN:\n        responseFormat = planSchema;\n        break;\n    }\n  }\n\n  // gpt-4o-2024-05-13 only supports json_object response format\n  if (model === 'gpt-4o-2024-05-13') {\n    responseFormat = { type: AIResponseFormat.JSON };\n  }\n\n  const response = await call(messages, AIActionTypeValue, responseFormat);\n  assert(response, 'empty response');\n  const jsonContent = safeParseJson(response.content);\n  return { content: jsonContent, usage: response.usage };\n}\n\nexport function extractJSONFromCodeBlock(response: string) {\n  try {\n    // First, try to match a JSON object directly in the response\n    const jsonMatch = response.match(/^\\s*(\\{[\\s\\S]*\\})\\s*$/);\n    if (jsonMatch) {\n      return jsonMatch[1];\n    }\n\n    // If no direct JSON object is found, try to extract JSON from a code block\n    const codeBlockMatch = response.match(\n      /```(?:json)?\\s*(\\{[\\s\\S]*?\\})\\s*```/,\n    );\n    if (codeBlockMatch) {\n      return codeBlockMatch[1];\n    }\n\n    // If no code block is found, try to find a JSON-like structure in the text\n    const jsonLikeMatch = response.match(/\\{[\\s\\S]*\\}/);\n    if (jsonLikeMatch) {\n      return jsonLikeMatch[0];\n    }\n  } catch {}\n  // If no JSON-like structure is found, return the original response\n  return response;\n}\n\nexport function preprocessDoubaoBboxJson(input: string) {\n  // replace all /\\d+\\s+\\d+/g with /$1,$2/g\n  return input.replace(/(\\d+)\\s+(\\d+)/g, '$1,$2');\n}\n\nexport function safeParseJson(input: string) {\n  const cleanJsonString = extractJSONFromCodeBlock(input);\n  // match the point\n  if (cleanJsonString?.match(/\\((\\d+),(\\d+)\\)/)) {\n    return cleanJsonString\n      .match(/\\((\\d+),(\\d+)\\)/)\n      ?.slice(1)\n      .map(Number);\n  }\n  try {\n    return JSON.parse(cleanJsonString);\n  } catch {}\n  try {\n    return dJSON.parse(cleanJsonString);\n  } catch (e) {}\n\n  if (vlLocateMode() === 'doubao-vision') {\n    const jsonString = preprocessDoubaoBboxJson(cleanJsonString);\n    return dJSON.parse(jsonString);\n  }\n  throw Error(`failed to parse json response: ${input}`);\n}\n","import type { AIUsageInfo, Size } from '@/types';\nimport { assert } from '@midscene/shared/utils';\n\nimport type {\n  ChatCompletionSystemMessageParam,\n  ChatCompletionUserMessageParam,\n} from 'openai/resources';\nimport {\n  callToGetJSONObject,\n  checkAIConfig,\n  getModelName,\n} from './service-caller/index';\n\nimport { vlLocateMode } from '@/env';\nimport type { PlanningLocateParam } from '@/types';\n\nexport type AIArgs = [\n  ChatCompletionSystemMessageParam,\n  ChatCompletionUserMessageParam,\n];\n\nexport enum AIActionType {\n  ASSERT = 0,\n  INSPECT_ELEMENT = 1,\n  EXTRACT_DATA = 2,\n  PLAN = 3,\n}\n\nexport async function callAiFn<T>(\n  msgs: AIArgs,\n  AIActionTypeValue: AIActionType,\n): Promise<{ content: T; usage?: AIUsageInfo }> {\n  assert(\n    checkAIConfig(),\n    'Cannot find config for AI model service. If you are using a self-hosted model without validating the API key, please set `OPENAI_API_KEY` to any non-null value. https://midscenejs.com/model-provider.html',\n  );\n\n  const { content, usage } = await callToGetJSONObject<T>(\n    msgs,\n    AIActionTypeValue,\n  );\n  return { content, usage };\n}\n\nconst defaultBboxSize = 20;\n\n// transform the param of locate from qwen mode\nexport function fillLocateParam(\n  locate: PlanningLocateParam,\n  width: number,\n  height: number,\n  errorMsg?: string,\n) {\n  // The Qwen model might have hallucinations of naming bbox as bbox_2d.\n  if ((locate as any).bbox_2d && !locate?.bbox) {\n    locate.bbox = (locate as any).bbox_2d;\n    // biome-ignore lint/performance/noDelete: <explanation>\n    delete (locate as any).bbox_2d;\n  }\n\n  if (locate?.bbox) {\n    locate.bbox = adaptBbox(locate.bbox, width, height, errorMsg);\n  }\n\n  return locate;\n}\n\nexport function adaptQwenBbox(\n  bbox: number[],\n  errorMsg?: string,\n): [number, number, number, number] {\n  if (bbox.length < 2) {\n    const msg =\n      errorMsg ||\n      `invalid bbox data for qwen-vl mode: ${JSON.stringify(bbox)} `;\n    throw new Error(msg);\n  }\n\n  const result: [number, number, number, number] = [\n    Math.round(bbox[0]),\n    Math.round(bbox[1]),\n    typeof bbox[2] === 'number'\n      ? Math.round(bbox[2])\n      : Math.round(bbox[0] + defaultBboxSize),\n    typeof bbox[3] === 'number'\n      ? Math.round(bbox[3])\n      : Math.round(bbox[1] + defaultBboxSize),\n  ];\n  return result;\n}\n\nexport function adaptDoubaoBbox(\n  bbox: number[],\n  width: number,\n  height: number,\n  errorMsg?: string,\n): [number, number, number, number] {\n  assert(\n    width > 0 && height > 0,\n    'width and height must be greater than 0 in doubao mode',\n  );\n  if (bbox.length === 4) {\n    return [\n      Math.round((bbox[0] * width) / 1000),\n      Math.round((bbox[1] * height) / 1000),\n      Math.round((bbox[2] * width) / 1000),\n      Math.round((bbox[3] * height) / 1000),\n    ];\n  }\n\n  if (bbox.length === 6 || bbox.length === 2) {\n    return [\n      Math.round((bbox[0] * width) / 1000),\n      Math.round((bbox[1] * height) / 1000),\n      Math.round((bbox[0] * width) / 1000) + defaultBboxSize,\n      Math.round((bbox[1] * height) / 1000) + defaultBboxSize,\n    ];\n  }\n\n  if (bbox.length === 8) {\n    return [\n      Math.round((bbox[0] * width) / 1000),\n      Math.round((bbox[1] * height) / 1000),\n      Math.round((bbox[4] * width) / 1000),\n      Math.round((bbox[5] * height) / 1000),\n    ];\n  }\n\n  const msg =\n    errorMsg ||\n    `invalid bbox data for doubao-vision mode: ${JSON.stringify(bbox)} `;\n  throw new Error(msg);\n}\n\nexport function adaptBbox(\n  bbox: number[],\n  width: number,\n  height: number,\n  errorMsg?: string,\n): [number, number, number, number] {\n  if (vlLocateMode() === 'doubao-vision') {\n    return adaptDoubaoBbox(bbox, width, height, errorMsg);\n  }\n\n  return adaptQwenBbox(bbox, errorMsg);\n}\n\nlet warned = false;\nexport function warnGPT4oSizeLimit(size: Size) {\n  if (warned) return;\n  if (getModelName()?.toLowerCase().includes('gpt-4o')) {\n    const warningMsg = `GPT-4o has a maximum image input size of 2000x768 or 768x2000, but got ${size.width}x${size.height}. Please set your page to a smaller resolution. Otherwise, the result may be inaccurate.`;\n\n    if (\n      Math.max(size.width, size.height) > 2000 ||\n      Math.min(size.width, size.height) > 768\n    ) {\n      console.warn(warningMsg);\n      warned = true;\n    }\n  }\n}\n","import type { Action } from '../ui-tars-planning';\n\nexport function getTimeZoneInfo(): { timezone: string; isChina: boolean } {\n  const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;\n  const offset = -new Date().getTimezoneOffset() / 60;\n\n  return {\n    timezone: `UTC${offset >= 0 ? '+' : ''}${offset}`,\n    isChina: timeZone === 'Asia/Shanghai',\n  };\n}\n\nexport const language = getTimeZoneInfo().isChina ? 'Chinese' : 'English';\n\nexport const uiTarsPlanningPrompt = `\nYou are a GUI agent. You are given a task and your action history, with screenshots. You need to perform the next action to complete the task. \n\n## Output Format\n\\`\\`\\`\nThought: ...\nAction: ...\n\\`\\`\\`\n\n## Action Space\nclick(start_box='[x1, y1, x2, y2]')\nleft_double(start_box='[x1, y1, x2, y2]')\nright_single(start_box='[x1, y1, x2, y2]')\ndrag(start_box='[x1, y1, x2, y2]', end_box='[x3, y3, x4, y4]')\nhotkey(key='')\ntype(content='') #If you want to submit your input, use \"\\\\n\" at the end of \\`content\\`.\nscroll(start_box='[x1, y1, x2, y2]', direction='down or up or right or left')\nwait() #Sleep for 5s and take a screenshot to check for any changes.\nfinished()\ncall_user() # Submit the task and call the user when the task is unsolvable, or when you need the user's help.\n\n## Note\n- Use ${language} in \\`Thought\\` part.\n- Write a small plan and finally summarize your next action (with its target element) in one sentence in \\`Thought\\` part.\n\n## User Instruction\n`;\n\nexport const getSummary = (prediction: string) =>\n  prediction\n    .replace(/Reflection:[\\s\\S]*?(?=Action_Summary:|Action:|$)/g, '')\n    .trim();\n","import type { ResponseFormatJSONSchema } from 'openai/resources';\nimport { getTimeZoneInfo } from './ui-tars-planning';\n\nexport const language = getTimeZoneInfo().isChina ? 'Chinese' : 'English';\nconst defaultAssertionPrompt =\n  'You are a senior testing engineer. User will give an assertion and a screenshot of a page. By carefully viewing the screenshot, please tell whether the assertion is truthy.';\n\nconst defaultAssertionResponseJsonFormat = `Return in the following JSON format:\n{\n  pass: boolean, // whether the assertion is truthy\n  thought: string | null, // string, if the result is falsy, give the reason why it is falsy. Otherwise, put null.\n}`;\n\nconst uiTarsAssertionResponseJsonFormat = `## Output Json String Format\n\\`\\`\\`\n\"{\n  \"pass\": <<is a boolean value from the enum [true, false], true means the assertion is truthy>>, \n  \"thought\": \"<<is a string, give the reason why the assertion is falsy or truthy. Otherwise.>>\"\n}\"\n\\`\\`\\`\n\n## Rules **MUST** follow\n- Make sure to return **only** the JSON, with **no additional** text or explanations.\n- Use ${language} in \\`thought\\` part.\n- You **MUST** strictly follow up the **Output Json String Format**.`;\n\nexport function systemPromptToAssert(model: { isUITars: boolean }) {\n  return `${defaultAssertionPrompt}\n\n${model.isUITars ? uiTarsAssertionResponseJsonFormat : defaultAssertionResponseJsonFormat}`;\n}\n\nexport const assertSchema: ResponseFormatJSONSchema = {\n  type: 'json_schema',\n  json_schema: {\n    name: 'assert',\n    strict: true,\n    schema: {\n      type: 'object',\n      properties: {\n        pass: {\n          type: 'boolean',\n          description: 'Whether the assertion passed or failed',\n        },\n        thought: {\n          type: ['string', 'null'],\n          description: 'The thought process behind the assertion',\n        },\n      },\n      required: ['pass', 'thought'],\n      additionalProperties: false,\n    },\n  },\n};\n","import { vlLocateMode } from '@/env';\nimport { PromptTemplate } from '@langchain/core/prompts';\nimport type { ResponseFormatJSONSchema } from 'openai/resources';\n\nexport function systemPromptToLocateElement() {\n  if (vlLocateMode()) {\n    return `\n## Role:\nYou are an expert in software testing.\n\n## Objective:\n- Identify elements in screenshots and text that match the user's description.\n- Give the coordinates of the element that matches the user's description best in the screenshot.\n\n## Output Format:\n\\`\\`\\`json\n{\n  \"bbox\": [number, number, number, number],  // top-left x, top-left y, bottom-right x, bottom-right y\n  \"errors\"?: string[]\n}\n\\`\\`\\`\n\nFields:\n* \\`bbox\\` is the bounding box of the element that matches the user's description best in the screenshot\n* \\`errors\\` is an optional array of error messages (if any)\n`;\n  }\n\n  return `\n## Role:\nYou are an expert in software page image (2D) and page element text analysis.\n\n## Objective:\n- Identify elements in screenshots and text that match the user's description.\n- Return JSON data containing the selection reason and element ID.\n\n## Skills:\n- Image analysis and recognition\n- Multilingual text understanding\n- Software UI design and testing\n\n## Workflow:\n1. Receive the user's element description, screenshot, and element description information. Note that the text may contain non-English characters (e.g., Chinese), indicating that the application may be non-English.\n2. Based on the user's description, locate the target element ID in the list of element descriptions and the screenshot.\n3. Found the required number of elements\n4. Return JSON data containing the selection reason and element ID.\n\n## Constraints:\n- Strictly adhere to the specified location when describing the required element; do not select elements from other locations.\n- Elements in the image with NodeType other than \"TEXT Node\" have been highlighted to identify the element among multiple non-text elements.\n- Accurately identify element information based on the user's description and return the corresponding element ID from the element description information, not extracted from the image.\n- If no elements are found, the \"elements\" array should be empty.\n- The returned data must conform to the specified JSON format.\n- The returned value id information must use the id from element info (important: **use id not indexId, id is hash content**)\n\n## Output Format:\n\nPlease return the result in JSON format as follows:\n\n\\`\\`\\`json\n{\n  \"elements\": [\n    // If no matching elements are found, return an empty array []\n    {\n      \"reason\": \"PLACEHOLDER\", // The thought process for finding the element, replace PLACEHOLDER with your thought process\n      \"text\": \"PLACEHOLDER\", // Replace PLACEHOLDER with the text of elementInfo, if none, leave empty\n      \"id\": \"PLACEHOLDER\" // Replace PLACEHOLDER with the ID (important: **use id not indexId, id is hash content**) of elementInfo\n    }\n    // More elements...\n  ],\n  \"errors\": [] // Array of strings containing any error messages\n}\n\\`\\`\\`\n\n## Example:\nExample 1:\nInput Example:\n\\`\\`\\`json\n// Description: \"Shopping cart icon in the upper right corner\"\n{\n  \"description\": \"PLACEHOLDER\", // Description of the target element\n  \"screenshot\": \"path/screenshot.png\",\n  \"text\": '{\n      \"pageSize\": {\n        \"width\": 400, // Width of the page\n        \"height\": 905 // Height of the page\n      },\n      \"elementInfos\": [\n        {\n          \"id\": \"1231\", // ID of the element\n          \"indexId\": \"0\", // Index of the elementThe image is labeled to the left of the element\n          \"attributes\": { // Attributes of the element\n            \"nodeType\": \"IMG Node\", // Type of element, types include: TEXT Node, IMG Node, BUTTON Node, INPUT Node\n            \"src\": \"https://ap-southeast-3.m\",\n            \"class\": \".img\"\n          },\n          \"content\": \"\", // Text content of the element\n          \"rect\": {\n            \"left\": 280, // Distance from the left side of the page\n            \"top\": 8, // Distance from the top of the page\n            \"width\": 44, // Width of the element\n            \"height\": 44 // Height of the element\n          }\n        },\n        {\n          \"id\": \"66551\", // ID of the element\n          \"indexId\": \"1\", // Index of the element,The image is labeled to the left of the element\n          \"attributes\": { // Attributes of the element\n            \"nodeType\": \"IMG Node\", // Type of element, types include: TEXT Node, IMG Node, BUTTON Node, INPUT Node\n            \"src\": \"data:image/png;base64,iVBORw0KGgoAAAANSU...\",\n            \"class\": \".icon\"\n          },\n          \"content\": \"\", // Text content of the element\n          \"rect\": {\n            \"left\": 350, // Distance from the left side of the page\n            \"top\": 16, // Distance from the top of the page\n            \"width\": 25, // Width of the element\n            \"height\": 25 // Height of the element\n          }\n        },\n        ...\n        {\n          \"id\": \"12344\",\n          \"indexId\": \"2\", // Index of the elementThe image is labeled to the left of the element\n          \"attributes\": {\n            \"nodeType\": \"TEXT Node\",\n            \"class\": \".product-name\"\n          },\n          \"center\": [\n            288,\n            834\n          ],\n          \"content\": \"Mango Drink\",\n          \"rect\": {\n            \"left\": 188,\n            \"top\": 827,\n            \"width\": 199,\n            \"height\": 13\n          }\n        },\n        ...\n      ]\n    }\n  '\n}\n\\`\\`\\`\nOutput Example:\n\\`\\`\\`json\n{\n  \"elements\": [\n    {\n      // Describe the reason for finding this element, replace with actual value in practice\n      \"reason\": \"Reason for finding element 4: It is located in the upper right corner, is an image type, and according to the screenshot, it is a shopping cart icon button\",\n      \"text\": \"\",\n      // ID(**use id not indexId**) of this element, replace with actual value in practice, **use id not indexId**\n      \"id\": \"1231\"\n    }\n  ],\n  \"errors\": []\n}\n\\`\\`\\`\n  \n  `;\n}\n\nexport const locatorSchema: ResponseFormatJSONSchema = {\n  type: 'json_schema',\n  json_schema: {\n    name: 'find_elements',\n    strict: true,\n    schema: {\n      type: 'object',\n      properties: {\n        elements: {\n          type: 'array',\n          items: {\n            type: 'object',\n            properties: {\n              reason: {\n                type: 'string',\n                description: 'Reason for finding this element',\n              },\n              text: {\n                type: 'string',\n                description: 'Text content of the element',\n              },\n              id: {\n                type: 'string',\n                description: 'ID of this element',\n              },\n            },\n            required: ['reason', 'text', 'id'],\n            additionalProperties: false,\n          },\n          description: 'List of found elements',\n        },\n        errors: {\n          type: 'array',\n          items: {\n            type: 'string',\n          },\n          description: 'List of error messages, if any',\n        },\n      },\n      required: ['elements', 'errors'],\n      additionalProperties: false,\n    },\n  },\n};\n\nexport const findElementPrompt = new PromptTemplate({\n  template: `\nHere is the item user want to find:\n=====================================\n{targetElementDescription}\n=====================================\n\n{pageDescription}\n  `,\n  inputVariables: ['pageDescription', 'targetElementDescription'],\n});\n","import { vlLocateMode } from '@/env';\nimport { PromptTemplate } from '@langchain/core/prompts';\nimport type { ResponseFormatJSONSchema } from 'openai/resources';\nimport { samplePageDescription } from './util';\n\n// Note: put the log field first to trigger the CoT\nconst vlCoTLog = `\"what_the_user_wants_to_do_next_by_instruction\": string, // What the user wants to do according to the instruction and previous logs. `;\nconst vlCurrentLog = `\"log\": string, // Log what the next one action (ONLY ONE!) you can do according to the screenshot and the instruction. The typical log looks like \"I will use action {{ action-type }} to do ..\". If no action should be done, log the reason. \". Use the same language as the user's instruction.`;\nconst llmCurrentLog = `\"log\": string, // Log what the next actions you can do according to the screenshot and the instruction. The typical log looks like \"I will use action {{ action-type }} to do ..\". If no action should be done, log the reason. \". Use the same language as the user's instruction.`;\n\nconst commonOutputFields = `\"error\"?: string, // Error messages about unexpected situations, if any. Only think it is an error when the situation is not expected according to the instruction. Use the same language as the user's instruction.\n  \"more_actions_needed_by_instruction\": boolean, // Consider if there is still more action(s) to do after the action in \"Log\" is done, according to the instruction. If so, set this field to true. Otherwise, set it to false.`;\n\nconst vlLocateParam =\n  'locate: {bbox: [number, number, number, number], prompt: string }';\n\nconst systemTemplateOfVLPlanning = `\nTarget: User will give you a screenshot, an instruction and some previous logs indicating what have been done. Please tell what the next one action is (or null if no action should be done) to do the tasks the instruction requires. \n\nRestriction:\n- Don't give extra actions or plans beyond the instruction. ONLY plan for what the instruction requires. For example, don't try to submit the form if the instruction is only to fill something.\n- Always give ONLY ONE action in \\`log\\` field (or null if no action should be done), instead of multiple actions. Supported actions are Tap, Hover, Input, KeyboardPress, Scroll.\n- Don't repeat actions in the previous logs.\n- Bbox is the bounding box of the element to be located. It's an array of 4 numbers, representing the top-left x, top-left y, bottom-right x, bottom-right y of the element.\n\nSupporting actions:\n- Tap: { type: \"Tap\", ${vlLocateParam} }\n- Hover: { type: \"Hover\", ${vlLocateParam} }\n- Input: { type: \"Input\", ${vlLocateParam}, param: { value: string } } // \\`value\\` is the final that should be filled in the input box. No matter what modifications are required, just provide the final value to replace the existing input value. \n- KeyboardPress: { type: \"KeyboardPress\", param: { value: string } }\n- Scroll: { type: \"Scroll\", ${vlLocateParam} | null, param: { direction: 'down'(default) | 'up' | 'right' | 'left', scrollType: 'once' (default) | 'untilBottom' | 'untilTop' | 'untilRight' | 'untilLeft', distance: null | number }} // locate is the element to scroll. If it's a page scroll, put \\`null\\` in the \\`locate\\` field.\n\nField description:\n* The \\`prompt\\` field inside the \\`locate\\` field is a short description that could be used to locate the element.\n\nReturn in JSON format:\n{\n  ${vlCoTLog}\n  ${vlCurrentLog}\n  ${commonOutputFields}\n  \"action\": \n    {\n      // one of the supporting actions\n    } | null,\n  ,\n  \"sleep\"?: number, // The sleep time after the action, in milliseconds.\n}\n`;\n\nconst llmLocateParam = `locate: {{\"id\": string, \"prompt\": string}} | null`;\nconst systemTemplateOfLLM = `\n## Role\n\nYou are a versatile professional in software UI automation. Your outstanding contributions will impact the user experience of billions of users.\n\n## Objective\n\n- Decompose the instruction user asked into a series of actions\n- Locate the target element if possible\n- If the instruction cannot be accomplished, give a further plan.\n\n## Workflow\n\n1. Receive the screenshot, element description of screenshot(if any), user's instruction and previous logs.\n2. Decompose the user's task into a sequence of actions, and place it in the \\`actions\\` field. There are different types of actions (Tap / Hover / Input / KeyboardPress / Scroll / FalsyConditionStatement / Sleep). The \"About the action\" section below will give you more details.\n3. Precisely locate the target element if it's already shown in the screenshot, put the location info in the \\`locate\\` field of the action.\n4. If some target elements is not shown in the screenshot, consider the user's instruction is not feasible on this page. Follow the next steps.\n5. Consider whether the user's instruction will be accomplished after all the actions\n - If yes, set \\`taskWillBeAccomplished\\` to true\n - If no, don't plan more actions by closing the array. Get ready to reevaluate the task. Some talent people like you will handle this. Give him a clear description of what have been done and what to do next. Put your new plan in the \\`furtherPlan\\` field. The \"How to compose the \\`taskWillBeAccomplished\\` and \\`furtherPlan\\` fields\" section will give you more details.\n\n## Constraints\n\n- All the actions you composed MUST be based on the page context information you get.\n- Trust the \"What have been done\" field about the task (if any), don't repeat actions in it.\n- Respond only with valid JSON. Do not write an introduction or summary or markdown prefix like \\`\\`\\`json\\`\\`\\`.\n- If the screenshot and the instruction are totally irrelevant, set reason in the \\`error\\` field.\n\n## About the \\`actions\\` field\n\nThe \\`locate\\` param is commonly used in the \\`param\\` field of the action, means to locate the target element to perform the action, it conforms to the following scheme:\n\ntype LocateParam = {{\n  \"id\": string, // the id of the element found. It should either be the id marked with a rectangle in the screenshot or the id described in the description.\n  \"prompt\"?: string // the description of the element to find. It can only be omitted when locate is null.\n}} | null // If it's not on the page, the LocateParam should be null\n\n## Supported actions\n\nEach action has a \\`type\\` and corresponding \\`param\\`. To be detailed:\n- type: 'Tap'\n  * {{ ${llmLocateParam} }}\n- type: 'Hover'\n  * {{ ${llmLocateParam} }}\n- type: 'Input', replace the value in the input field\n  * {{ ${llmLocateParam}, param: {{ value: string }} }}\n  * \\`value\\` is the final value that should be filled in the input field. No matter what modifications are required, just provide the final value user should see after the action is done. \n- type: 'KeyboardPress', press a key\n  * {{ param: {{ value: string }} }}\n- type: 'Scroll', scroll up or down.\n  * {{ \n      ${llmLocateParam}, \n      param: {{ \n        direction: 'down'(default) | 'up' | 'right' | 'left', \n        scrollType: 'once' (default) | 'untilBottom' | 'untilTop' | 'untilRight' | 'untilLeft', \n        distance: null | number \n      }} \n    }}\n    * To scroll some specific element, put the element at the center of the region in the \\`locate\\` field. If it's a page scroll, put \\`null\\` in the \\`locate\\` field. \n    * \\`param\\` is required in this action. If some fields are not specified, use direction \\`down\\`, \\`once\\` scroll type, and \\`null\\` distance.\n- type: 'ExpectedFalsyCondition'\n  * {{ param: {{ reason: string }} }}\n  * use this action when the conditional statement talked about in the instruction is falsy.\n- type: 'Sleep'\n  * {{ param: {{ timeMs: number }} }}\n`;\n\nconst outputTemplate = `\n## Output JSON Format:\n\nThe JSON format is as follows:\n\n{{\n  \"actions\": [\n    // ... some actions\n  ],\n  ${llmCurrentLog}\n  ${commonOutputFields}\n}}\n\n## Examples\n\n### Example: Decompose a task\n\nWhen the instruction is 'Click the language switch button, wait 1s, click \"English\"', and not log is provided\n\nBy viewing the page screenshot and description, you should consider this and output the JSON:\n\n* The main steps should be: tap the switch button, sleep, and tap the 'English' option\n* The language switch button is shown in the screenshot, but it's not marked with a rectangle. So we have to use the page description to find the element. By carefully checking the context information (coordinates, attributes, content, etc.), you can find the element.\n* The \"English\" option button is not shown in the screenshot now, it means it may only show after the previous actions are finished. So don't plan any action to do this.\n* Log what these action do: Click the language switch button to open the language options. Wait for 1 second.\n* The task cannot be accomplished (because we cannot see the \"English\" option now), so the \\`more_actions_needed_by_instruction\\` field is true.\n\n{{\n  \"actions\":[\n    {{\n      \"type\": \"Tap\", \n      \"thought\": \"Click the language switch button to open the language options.\",\n      \"param\": null,\n      \"locate\": {{ id: \"c81c4e9a33\", prompt: \"The language switch button\" }},\n    }},\n    {{\n      \"type\": \"Sleep\",\n      \"thought\": \"Wait for 1 second to ensure the language options are displayed.\",\n      \"param\": {{ \"timeMs\": 1000 }},\n    }}\n  ],\n  \"error\": null,\n  \"more_actions_needed_by_instruction\": true,\n  \"log\": \"Click the language switch button to open the language options. Wait for 1 second\",\n}}\n\n### Example: What NOT to do\nWrong output:\n{{\n  \"actions\":[\n    {{\n      \"type\": \"Tap\",\n      \"thought\": \"Click the language switch button to open the language options.\",\n      \"param\": null,\n      \"locate\": {{\n        {{ \"id\": \"c81c4e9a33\" }}, // WRONG: prompt is missing\n      }}\n    }},\n    {{\n      \"type\": \"Tap\", \n      \"thought\": \"Click the English option\",\n      \"param\": null,\n      \"locate\": null, // This means the 'English' option is not shown in the screenshot, the task cannot be accomplished\n    }}\n  ],\n  \"more_actions_needed_by_instruction\": false, // WRONG: should be true\n  \"log\": \"Click the language switch button to open the language options\",\n}}\n\nReason:\n* The \\`prompt\\` is missing in the first 'Locate' action\n* Since the option button is not shown in the screenshot, there are still more actions to be done, so the \\`more_actions_needed_by_instruction\\` field should be true\n`;\n\nexport async function systemPromptToTaskPlanning() {\n  if (vlLocateMode()) {\n    return systemTemplateOfVLPlanning;\n  }\n\n  const promptTemplate = new PromptTemplate({\n    template: `${systemTemplateOfLLM}\\n\\n${outputTemplate}`,\n    inputVariables: ['pageDescription'],\n  });\n\n  return await promptTemplate.format({\n    pageDescription: samplePageDescription,\n  });\n}\n\nexport const planSchema: ResponseFormatJSONSchema = {\n  type: 'json_schema',\n  json_schema: {\n    name: 'action_items',\n    strict: true,\n    schema: {\n      type: 'object',\n      strict: true,\n      properties: {\n        actions: {\n          //  TODO\n          type: 'array',\n          items: {\n            type: 'object',\n            strict: true,\n            properties: {\n              thought: {\n                type: 'string',\n                description:\n                  'Reasons for generating this task, and why this task is feasible on this page',\n              },\n              type: {\n                type: 'string',\n                description:\n                  'Type of action, one of \"Tap\", \"Hover\" , \"Input\", \"KeyboardPress\", \"Scroll\", \"ExpectedFalsyCondition\", \"Sleep\"',\n              },\n              param: {\n                anyOf: [\n                  { type: 'null' },\n                  {\n                    type: 'object',\n                    properties: { value: { type: ['string', 'number'] } },\n                    required: ['value'],\n                    additionalProperties: false,\n                  },\n                  {\n                    type: 'object',\n                    properties: { timeMs: { type: ['number', 'string'] } },\n                    required: ['timeMs'],\n                    additionalProperties: false,\n                  },\n                  {\n                    type: 'object',\n                    properties: {\n                      direction: { type: 'string' },\n                      scrollType: { type: 'string' },\n                      distance: { type: ['number', 'string', 'null'] },\n                    },\n                    required: ['direction', 'scrollType', 'distance'],\n                    additionalProperties: false,\n                  },\n                  {\n                    type: 'object',\n                    properties: { reason: { type: 'string' } },\n                    required: ['reason'],\n                    additionalProperties: false,\n                  },\n                ],\n                description:\n                  'Parameter of the action, can be null ONLY when the type field is Tap or Hover',\n              },\n              locate: {\n                type: ['object', 'null'],\n                properties: {\n                  id: { type: 'string' },\n                  prompt: { type: 'string' },\n                },\n                required: ['id', 'prompt'],\n                additionalProperties: false,\n                description: 'Location information for the target element',\n              },\n            },\n            required: ['thought', 'type', 'param', 'locate'],\n            additionalProperties: false,\n          },\n          description: 'List of actions to be performed',\n        },\n        more_actions_needed_by_instruction: {\n          type: 'boolean',\n          description:\n            'If all the actions described in the instruction have been covered by this action and logs, set this field to false.',\n        },\n        log: {\n          type: 'string',\n          description:\n            'Log what these planned actions do. Do not include further actions that have not been planned.',\n        },\n        error: {\n          type: ['string', 'null'],\n          description: 'Error messages about unexpected situations',\n        },\n      },\n      required: [\n        'actions',\n        'more_actions_needed_by_instruction',\n        'log',\n        'error',\n      ],\n      additionalProperties: false,\n    },\n  },\n};\n\nexport const generateTaskBackgroundContext = (\n  userInstruction: string,\n  log?: string,\n) => {\n  if (log) {\n    return `\nHere is the user's instruction:\n<instruction>\n${userInstruction}\n</instruction>\n\nThese are the logs from previous executions, which indicate what was done in the previous actions.\nDo NOT repeat these actions.\n<previous_logs>\n${log}\n</previous_logs>\n`;\n  }\n\n  return `\nHere is the user's instruction:\n<instruction>\n${userInstruction}\n</instruction>\n`;\n};\n\nexport const automationUserPrompt = () => {\n  if (vlLocateMode()) {\n    return new PromptTemplate({\n      template: '{taskBackgroundContext}',\n      inputVariables: ['taskBackgroundContext'],\n    });\n  }\n\n  return new PromptTemplate({\n    template: `\npageDescription:\n=====================================\n{pageDescription}\n=====================================\n\n{taskBackgroundContext}\n    `,\n    inputVariables: ['pageDescription', 'taskBackgroundContext'],\n  });\n};\n","export {\n  imageInfo,\n  imageInfoOfBase64,\n  base64Encoded,\n  resizeImg,\n  transformImgPathToBase64,\n  saveBase64Image,\n  zoomForGPT4o,\n} from '@midscene/shared/img';\n","import { vlLocateMode } from '@/env';\nimport { imageInfoOfBase64 } from '@/image/index';\nimport type { BaseElement, ElementTreeNode, Size, UIContext } from '@/types';\nimport { NodeType } from '@midscene/shared/constants';\nimport { descriptionOfTree, treeToList } from '@midscene/shared/extractor';\nimport { assert } from '@midscene/shared/utils';\nimport { generateHashId } from '@midscene/shared/utils';\n\nexport function describeSize(size: Size) {\n  return `${size.width} x ${size.height}`;\n}\n\nexport function describeElement(\n  elements: (Pick<BaseElement, 'rect' | 'content'> & { id: string })[],\n) {\n  const sliceLength = 80;\n  return elements\n    .map((item) =>\n      [\n        item.id,\n        item.rect.left,\n        item.rect.top,\n        item.rect.left + item.rect.width,\n        item.rect.top + item.rect.height,\n        item.content.length > sliceLength\n          ? `${item.content.slice(0, sliceLength)}...`\n          : item.content,\n      ].join(', '),\n    )\n    .join('\\n');\n}\n\nexport function elementByPositionWithElementInfo(\n  treeRoot: ElementTreeNode<BaseElement>,\n  position: {\n    x: number;\n    y: number;\n  },\n) {\n  assert(typeof position !== 'undefined', 'position is required for query');\n\n  const matchingElements: BaseElement[] = [];\n\n  function dfs(node: ElementTreeNode<BaseElement>) {\n    if (node?.node) {\n      const item = node.node;\n      if (\n        item.rect.left <= position.x &&\n        position.x <= item.rect.left + item.rect.width &&\n        item.rect.top <= position.y &&\n        position.y <= item.rect.top + item.rect.height\n      ) {\n        matchingElements.push(item);\n      }\n    }\n\n    for (const child of node.children) {\n      dfs(child);\n    }\n  }\n\n  dfs(treeRoot);\n\n  if (matchingElements.length === 0) {\n    return undefined;\n  }\n\n  // Find the smallest element by area\n  const element = matchingElements.reduce((smallest, current) => {\n    const smallestArea = smallest.rect.width * smallest.rect.height;\n    const currentArea = current.rect.width * current.rect.height;\n    return currentArea < smallestArea ? current : smallest;\n  });\n\n  const distanceToCenter = distance(\n    { x: element.center[0], y: element.center[1] },\n    position,\n  );\n\n  return distanceToCenter <= distanceThreshold ? element : undefined;\n}\n\nexport const distanceThreshold = 16;\nexport function distance(\n  point1: { x: number; y: number },\n  point2: { x: number; y: number },\n) {\n  return Math.sqrt((point1.x - point2.x) ** 2 + (point1.y - point2.y) ** 2);\n}\n\nexport const samplePageDescription = `\nAnd the page is described as follows:\n====================\nThe size of the page: 1280 x 720\nSome of the elements are marked with a rectangle in the screenshot corresponding to the markerId, some are not.\n\nDescription of all the elements in screenshot:\n<div id=\"969f1637\" markerId=\"1\" left=\"100\" top=\"100\" width=\"100\" height=\"100\"> // The markerId indicated by the rectangle label in the screenshot\n  <h4 id=\"b211ecb2\" markerId=\"5\" left=\"150\" top=\"150\" width=\"90\" height=\"60\">\n    The username is accepted\n  </h4>\n  ...many more\n</div>\n====================\n`;\n\nexport async function describeUserPage<\n  ElementType extends BaseElement = BaseElement,\n>(\n  context: Omit<UIContext<ElementType>, 'describer'>,\n  opt?: {\n    truncateTextLength?: number;\n    filterNonTextContent?: boolean;\n  },\n) {\n  const { screenshotBase64 } = context;\n  let width: number;\n  let height: number;\n\n  if (context.size) {\n    ({ width, height } = context.size);\n  } else {\n    const imgSize = await imageInfoOfBase64(screenshotBase64);\n    ({ width, height } = imgSize);\n  }\n\n  const treeRoot = context.tree;\n  // dfs tree, save the id and element info\n  const idElementMap: Record<string, ElementType> = {};\n  const flatElements: ElementType[] = treeToList(treeRoot);\n  flatElements.forEach((element) => {\n    idElementMap[element.id] = element;\n    if (typeof element.indexId !== 'undefined') {\n      idElementMap[`${element.indexId}`] = element;\n    }\n  });\n\n  const contentTree = await descriptionOfTree(\n    treeRoot,\n    opt?.truncateTextLength,\n    opt?.filterNonTextContent,\n  );\n\n  // if match by position, don't need to provide the page description\n  const pageJSONDescription = vlLocateMode()\n    ? ''\n    : `Some of the elements are marked with a rectangle in the screenshot, some are not. \\n The page elements tree:\\n${contentTree}`;\n  const sizeDescription = describeSize({ width, height });\n\n  return {\n    description: `The size of the page: ${sizeDescription} \\n ${pageJSONDescription}`,\n    elementById(id: string) {\n      assert(typeof id !== 'undefined', 'id is required for query');\n      const item = idElementMap[`${id}`];\n      return item;\n    },\n    elementByPosition(\n      position: { x: number; y: number },\n      size: { width: number; height: number },\n    ) {\n      // console.log('elementByPosition', { position, size });\n      return elementByPositionWithElementInfo(treeRoot, position);\n    },\n    insertElementByPosition(position: { x: number; y: number }) {\n      const rect = {\n        left: Math.max(position.x - 4, 0),\n        top: Math.max(position.y - 4, 0),\n        width: 8,\n        height: 8,\n      };\n      const id = generateHashId(rect);\n      const element = {\n        id,\n        attributes: { nodeType: NodeType.POSITION },\n        rect,\n        content: '',\n        center: [position.x, position.y],\n      } as ElementType;\n\n      treeRoot.children.push({\n        node: element,\n        children: [],\n      });\n      flatElements.push(element);\n      idElementMap[id] = element;\n      return element;\n    },\n    size: { width, height },\n  };\n}\n","import {\n  MIDSCENE_USE_QWEN_VL,\n  MIDSCENE_USE_VLM_UI_TARS,\n  getAIConfigInBoolean,\n  vlLocateMode,\n} from '@/env';\nimport type {\n  AIAssertionResponse,\n  AIElementCoordinatesResponse,\n  AIElementLocatorResponse,\n  AIElementResponse,\n  AISectionLocatorResponse,\n  AISectionParseResponse,\n  AISingleElementResponse,\n  AISingleElementResponseByPosition,\n  AIUsageInfo,\n  BaseElement,\n  ElementById,\n  ElementTreeNode,\n  Size,\n  UIContext,\n} from '@/types';\nimport { paddingToMatchBlock } from '@midscene/shared/img';\nimport { assert, getDebug } from '@midscene/shared/utils';\nimport type {\n  ChatCompletionSystemMessageParam,\n  ChatCompletionUserMessageParam,\n} from 'openai/resources';\nimport { AIActionType, adaptBbox, adaptQwenBbox, callAiFn } from './common';\nimport { systemPromptToAssert } from './prompt/assertion';\nimport { extractDataPrompt, systemPromptToExtract } from './prompt/extraction';\nimport {\n  findElementPrompt,\n  systemPromptToLocateElement,\n} from './prompt/llm-locator';\nimport {\n  sectionLocatorInstruction,\n  systemPromptToLocateSection,\n} from './prompt/llm-section-locator';\nimport {\n  describeUserPage,\n  distance,\n  distanceThreshold,\n  elementByPositionWithElementInfo,\n} from './prompt/util';\nimport { callToGetJSONObject } from './service-caller/index';\n\nexport type AIArgs = [\n  ChatCompletionSystemMessageParam,\n  ChatCompletionUserMessageParam,\n];\n\nconst liteContextConfig = {\n  filterNonTextContent: true,\n  truncateTextLength: 200,\n};\n\nconst debugInspect = getDebug('ai:inspect');\n\nfunction transformToAbsoluteCoords(\n  relativePosition: { x: number; y: number },\n  size: Size,\n) {\n  return {\n    x: Number(((relativePosition.x / 1000) * size.width).toFixed(3)),\n    y: Number(((relativePosition.y / 1000) * size.height).toFixed(3)),\n  };\n}\n\n// let index = 0;\nexport async function transformElementPositionToId(\n  aiResult: AIElementResponse | [number, number],\n  treeRoot: ElementTreeNode<BaseElement>,\n  size: { width: number; height: number },\n  insertElementByPosition: (position: { x: number; y: number }) => BaseElement,\n) {\n  const emptyResponse: AIElementResponse = {\n    errors: [],\n    elements: [],\n  };\n\n  const elementAtPosition = (center: { x: number; y: number }) => {\n    const element = elementByPositionWithElementInfo(treeRoot, center);\n    const distanceToCenter = element\n      ? distance({ x: element.center[0], y: element.center[1] }, center)\n      : 0;\n    return distanceToCenter <= distanceThreshold ? element : undefined;\n  };\n\n  if ('bbox' in aiResult) {\n    if (\n      !Array.isArray(aiResult.bbox) ||\n      (aiResult.bbox as number[]).length !== 4\n    ) {\n      return emptyResponse;\n    }\n\n    const centerX = Math.round((aiResult.bbox[0] + aiResult.bbox[2]) / 2);\n    const centerY = Math.round((aiResult.bbox[1] + aiResult.bbox[3]) / 2);\n\n    let element = elementAtPosition({ x: centerX, y: centerY });\n\n    if (!element) {\n      element = insertElementByPosition({\n        x: centerX,\n        y: centerY,\n      });\n    }\n    assert(\n      element,\n      `inspect: no element found with coordinates: ${JSON.stringify(aiResult.bbox)}`,\n    );\n    return {\n      errors: [],\n      elements: [\n        {\n          id: element.id,\n        },\n      ],\n      bbox: aiResult.bbox,\n    };\n  }\n\n  if (Array.isArray(aiResult)) {\n    // [number, number] coord\n    const relativePosition = aiResult;\n    const absolutePosition = transformToAbsoluteCoords(\n      {\n        x: relativePosition[0],\n        y: relativePosition[1],\n      },\n      size,\n    );\n\n    let element = elementAtPosition(absolutePosition);\n    if (!element) {\n      element = insertElementByPosition(absolutePosition);\n    }\n\n    assert(\n      element,\n      `inspect: no id found with position: ${JSON.stringify({ absolutePosition })}`,\n    );\n\n    return {\n      errors: [],\n      elements: [\n        {\n          id: element.id,\n        },\n      ],\n    };\n  }\n\n  return {\n    errors: aiResult.errors,\n    elements: aiResult.elements,\n  };\n}\n\nfunction matchQuickAnswer(\n  quickAnswer:\n    | Partial<AISingleElementResponse>\n    | Partial<AISingleElementResponseByPosition>\n    | undefined,\n  tree: ElementTreeNode<BaseElement>,\n  elementById: ElementById,\n  insertElementByPosition: (position: { x: number; y: number }) => BaseElement,\n): Awaited<ReturnType<typeof AiLocateElement>> | undefined {\n  if (!quickAnswer) {\n    return undefined;\n  }\n  if ('id' in quickAnswer && quickAnswer.id && elementById(quickAnswer.id)) {\n    return {\n      parseResult: {\n        elements: [quickAnswer as AISingleElementResponse],\n        errors: [],\n      },\n      rawResponse: JSON.stringify(quickAnswer),\n      elementById,\n    };\n  }\n\n  if ('bbox' in quickAnswer && quickAnswer.bbox) {\n    const centerPosition = {\n      x: Math.floor((quickAnswer.bbox[0] + quickAnswer.bbox[2]) / 2),\n      y: Math.floor((quickAnswer.bbox[1] + quickAnswer.bbox[3]) / 2),\n    };\n    let element = elementByPositionWithElementInfo(tree, centerPosition);\n    if (!element) {\n      element = insertElementByPosition(centerPosition);\n    }\n    return {\n      parseResult: {\n        elements: [element],\n        errors: [],\n      },\n      rawResponse: quickAnswer,\n      elementById,\n    } as any;\n  }\n\n  return undefined;\n}\n\nexport async function AiLocateElement<\n  ElementType extends BaseElement = BaseElement,\n>(options: {\n  context: UIContext<ElementType>;\n  targetElementDescription: string;\n  callAI?: typeof callAiFn<AIElementResponse | [number, number]>;\n  quickAnswer?: Partial<\n    AISingleElementResponse | AISingleElementResponseByPosition\n  >;\n}): Promise<{\n  parseResult: AIElementLocatorResponse;\n  rawResponse: string;\n  elementById: ElementById;\n  usage?: AIUsageInfo;\n}> {\n  const { context, targetElementDescription, callAI } = options;\n  const { screenshotBase64, screenshotBase64WithElementMarker } = context;\n  const { description, elementById, insertElementByPosition, size } =\n    await describeUserPage(context);\n  // meet quick answer\n  const quickAnswer = matchQuickAnswer(\n    options.quickAnswer,\n    context.tree,\n    elementById,\n    insertElementByPosition,\n  );\n  if (quickAnswer) {\n    return quickAnswer;\n  }\n\n  assert(\n    targetElementDescription,\n    'cannot find the target element description',\n  );\n\n  const userInstructionPrompt = await findElementPrompt.format({\n    pageDescription: description,\n    targetElementDescription,\n  });\n  const systemPrompt = systemPromptToLocateElement();\n\n  let imagePayload = screenshotBase64WithElementMarker || screenshotBase64;\n\n  if (getAIConfigInBoolean(MIDSCENE_USE_QWEN_VL)) {\n    // align image for qwen\n    imagePayload = await paddingToMatchBlock(imagePayload);\n  }\n\n  const msgs: AIArgs = [\n    { role: 'system', content: systemPrompt },\n    {\n      role: 'user',\n      content: [\n        {\n          type: 'image_url',\n          image_url: {\n            url: imagePayload,\n            detail: 'high',\n          },\n        },\n        {\n          type: 'text',\n          text: userInstructionPrompt,\n        },\n      ],\n    },\n  ];\n\n  const callAIFn =\n    callAI || callToGetJSONObject<AIElementResponse | [number, number]>;\n\n  const res = await callAIFn(msgs, AIActionType.INSPECT_ELEMENT);\n  const rawResponse = JSON.stringify(res.content);\n\n  if ('bbox' in res.content && Array.isArray(res.content.bbox)) {\n    const errorMsg = res.content.errors?.length\n      ? `Failed to parse bbox: ${res.content.errors?.join(',')}`\n      : '';\n    res.content.bbox = adaptBbox(\n      res.content.bbox,\n      context.size.width,\n      context.size.height,\n      errorMsg,\n    );\n    debugInspect('res.content.bbox after adapt', res.content.bbox);\n  }\n\n  const parseResult = await transformElementPositionToId(\n    res.content,\n    context.tree,\n    size,\n    insertElementByPosition,\n  );\n\n  return {\n    parseResult,\n    rawResponse,\n    elementById,\n    usage: res.usage,\n  };\n}\n\nexport async function AiLocateSection(options: {\n  context: UIContext<BaseElement>;\n  sectionDescription: string;\n  callAI?: typeof callAiFn<AISectionLocatorResponse>;\n}) {\n  const { context, sectionDescription } = options;\n  const { screenshotBase64 } = context;\n\n  const systemPrompt = systemPromptToLocateSection();\n  const sectionLocatorInstructionText = await sectionLocatorInstruction.format({\n    sectionDescription,\n  });\n  const msgs: AIArgs = [\n    { role: 'system', content: systemPrompt },\n    {\n      role: 'user',\n      content: [\n        {\n          type: 'image_url',\n          image_url: {\n            url: screenshotBase64,\n            detail: 'high',\n          },\n        },\n        {\n          type: 'text',\n          text: sectionLocatorInstructionText,\n        },\n      ],\n    },\n  ];\n\n  const result = await callAiFn<AISectionLocatorResponse>(\n    msgs,\n    AIActionType.EXTRACT_DATA,\n  );\n\n  return {\n    sectionBbox: result.content.bbox,\n    rawResponse: JSON.stringify(result.content),\n    usage: result.usage,\n  };\n}\n\nexport async function AiExtractElementInfo<\n  T,\n  ElementType extends BaseElement = BaseElement,\n>(options: {\n  dataQuery: string | Record<string, string>;\n  context: UIContext<ElementType>;\n}) {\n  const { dataQuery, context } = options;\n  const systemPrompt = systemPromptToExtract();\n\n  const { screenshotBase64 } = context;\n  const { description, elementById } = await describeUserPage(\n    context,\n    liteContextConfig,\n  );\n\n  let dataKeys = '';\n  let dataQueryText = '';\n  if (typeof dataQuery === 'string') {\n    dataKeys = '';\n    dataQueryText = dataQuery;\n  } else {\n    dataKeys = `return in key-value style object, keys are ${Object.keys(dataQuery).join(',')}`;\n    dataQueryText = JSON.stringify(dataQuery, null, 2);\n  }\n  const extractDataPromptText = await extractDataPrompt.format({\n    pageDescription: description,\n    dataKeys,\n    dataQuery: dataQueryText,\n  });\n\n  const msgs: AIArgs = [\n    { role: 'system', content: systemPrompt },\n    {\n      role: 'user',\n      content: [\n        {\n          type: 'image_url',\n          image_url: {\n            url: screenshotBase64,\n            detail: 'high',\n          },\n        },\n        {\n          type: 'text',\n          text: extractDataPromptText,\n        },\n      ],\n    },\n  ];\n\n  const result = await callAiFn<AISectionParseResponse<T>>(\n    msgs,\n    AIActionType.EXTRACT_DATA,\n  );\n  return {\n    parseResult: result.content,\n    elementById,\n    usage: result.usage,\n  };\n}\n\nexport async function AiAssert<\n  ElementType extends BaseElement = BaseElement,\n>(options: { assertion: string; context: UIContext<ElementType> }) {\n  const { assertion, context } = options;\n\n  assert(assertion, 'assertion should be a string');\n\n  const { screenshotBase64 } = context;\n\n  const systemPrompt = systemPromptToAssert({\n    isUITars: getAIConfigInBoolean(MIDSCENE_USE_VLM_UI_TARS),\n  });\n\n  const msgs: AIArgs = [\n    { role: 'system', content: systemPrompt },\n    {\n      role: 'user',\n      content: [\n        {\n          type: 'image_url',\n          image_url: {\n            url: screenshotBase64,\n            detail: 'high',\n          },\n        },\n        {\n          type: 'text',\n          text: `\nHere is the assertion. Please tell whether it is truthy according to the screenshot.\n=====================================\n${assertion}\n=====================================\n  `,\n        },\n      ],\n    },\n  ];\n\n  const { content: assertResult, usage } = await callAiFn<AIAssertionResponse>(\n    msgs,\n    AIActionType.ASSERT,\n  );\n  return {\n    content: assertResult,\n    usage,\n  };\n}\n","import { PromptTemplate } from '@langchain/core/prompts';\nimport type { ResponseFormatJSONSchema } from 'openai/resources';\n\nexport function systemPromptToExtract() {\n  return `\nYou are a versatile professional in software UI design and testing. Your outstanding contributions will impact the user experience of billions of users.\n\nThe user will give you a screenshot, the contents of it (optional), and some data requirements in DATA_DEMAND. You need to extract the data according to the DATA_DEMAND.\n\nReturn in the following JSON format:\n{\n  data: any, // the extracted data from extract_data_from_UI skill. Make sure both the value and scheme meet the DATA_DEMAND. If you want to write some description in this field, use the same language as the DATA_DEMAND.\n  errors: [], // string[], error message if any\n}\n`;\n}\n\nexport const extractDataPrompt = new PromptTemplate({\n  template: `\npageDescription: {pageDescription}\n\nUse your extract_data_from_UI skill to find the following data, placing it in the \\`data\\` field\nDATA_DEMAND start:\n=====================================\n{dataKeys}\n\n{dataQuery}\n=====================================\nDATA_DEMAND ends.\n  `,\n  inputVariables: ['pageDescription', 'dataKeys', 'dataQuery'],\n});\n\nexport const extractDataSchema: ResponseFormatJSONSchema = {\n  type: 'json_schema',\n  json_schema: {\n    name: 'extract_data',\n    strict: true,\n    schema: {\n      type: 'object',\n      properties: {\n        data: {\n          type: 'object',\n          description: 'The extracted data from extract_data_from_UI skill',\n        },\n        errors: {\n          type: 'array',\n          items: {\n            type: 'string',\n          },\n          description: 'Error messages, if any',\n        },\n      },\n      required: ['data', 'errors'],\n      additionalProperties: false,\n    },\n  },\n};\n","import { PromptTemplate } from '@langchain/core/prompts';\n\nexport function systemPromptToLocateSection() {\n  return `\nYou goal is to find out some sections in the screenshot (or the section containing the target element) that the user is interested in. Make sure to include everything the user mentioned in this section.\n\nUsually, it should be approximately an area not more than 300x300px. Changes of the size are allowed.\n\nreturn in this JSON format:\n\\`\\`\\`json\n{\n  \"bbox\": [number, number, number, number],\n  \"error\"?: string\n}\n\\`\\`\\`\n`;\n}\n\nexport const sectionLocatorInstruction = new PromptTemplate({\n  template: `Here is the section user interested in:\n<sectionDescription>\n{sectionDescription}\n</sectionDescription>\n  `,\n  inputVariables: ['sectionDescription'],\n});\n","import { vlLocateMode } from '@/env';\nimport type { PlanningAIResponse, UIContext } from '@/types';\nimport { paddingToMatchBlock } from '@midscene/shared/img';\nimport { assert } from '@midscene/shared/utils';\nimport {\n  AIActionType,\n  type AIArgs,\n  callAiFn,\n  fillLocateParam,\n  warnGPT4oSizeLimit,\n} from './common';\nimport {\n  automationUserPrompt,\n  generateTaskBackgroundContext,\n  systemPromptToTaskPlanning,\n} from './prompt/llm-planning';\nimport { describeUserPage } from './prompt/util';\n\nexport async function plan(\n  userInstruction: string,\n  opts: {\n    log?: string;\n    context: UIContext;\n    callAI?: typeof callAiFn<PlanningAIResponse>;\n  },\n): Promise<PlanningAIResponse> {\n  const { callAI, context } = opts || {};\n  const { screenshotBase64, screenshotBase64WithElementMarker, size } = context;\n  const { description: pageDescription } = await describeUserPage(context);\n\n  const systemPrompt = await systemPromptToTaskPlanning();\n  const taskBackgroundContextText = generateTaskBackgroundContext(\n    userInstruction,\n    opts.log,\n  );\n  const userInstructionPrompt = await automationUserPrompt().format({\n    pageDescription,\n    taskBackgroundContext: taskBackgroundContextText,\n  });\n\n  let imagePayload = screenshotBase64WithElementMarker || screenshotBase64;\n  if (vlLocateMode()) {\n    imagePayload = await paddingToMatchBlock(imagePayload);\n  }\n\n  warnGPT4oSizeLimit(size);\n\n  const msgs: AIArgs = [\n    { role: 'system', content: systemPrompt },\n    {\n      role: 'user',\n      content: [\n        {\n          type: 'image_url',\n          image_url: {\n            url: imagePayload,\n            detail: 'high',\n          },\n        },\n        {\n          type: 'text',\n          text: userInstructionPrompt,\n        },\n      ],\n    },\n  ];\n\n  const call = callAI || callAiFn;\n  const { content, usage } = await call(msgs, AIActionType.PLAN);\n  const rawResponse = JSON.stringify(content, undefined, 2);\n  const planFromAI = content;\n\n  const actions =\n    (planFromAI.action?.type ? [planFromAI.action] : planFromAI.actions) || [];\n  const returnValue: PlanningAIResponse = {\n    ...planFromAI,\n    actions,\n    rawResponse,\n    usage,\n  };\n\n  assert(planFromAI, \"can't get plans from AI\");\n\n  if (vlLocateMode()) {\n    actions.forEach((action) => {\n      if (action.locate) {\n        action.locate = fillLocateParam(\n          action.locate,\n          size.width,\n          size.height,\n          planFromAI.error,\n        );\n      }\n    });\n    // in Qwen-VL, error means error. In GPT-4o, error may mean more actions are needed.\n    assert(!planFromAI.error, `Failed to plan actions: ${planFromAI.error}`);\n  }\n\n  if (\n    actions.length === 0 &&\n    returnValue.more_actions_needed_by_instruction &&\n    !returnValue.sleep\n  ) {\n    console.warn(\n      'No actions planned for the prompt, but model said more actions are needed:',\n      userInstruction,\n    );\n  }\n\n  return returnValue;\n}\n","import type { PlanningAction } from '@/types';\nimport { transformHotkeyInput } from '@midscene/shared/keyboard-layout';\nimport { assert } from '@midscene/shared/utils';\nimport { actionParser } from '@ui-tars/action-parser';\nimport type { ChatCompletionMessageParam } from 'openai/resources';\nimport { AIActionType } from './common';\nimport { getSummary, uiTarsPlanningPrompt } from './prompt/ui-tars-planning';\nimport { call } from './service-caller/index';\ntype ActionType =\n  | 'click'\n  | 'drag'\n  | 'type'\n  | 'hotkey'\n  | 'finished'\n  | 'scroll'\n  | 'wait';\n\nconst bboxSize = 10;\nconst pointToBbox = (\n  point: { x: number; y: number },\n  width: number,\n  height: number,\n): [number, number, number, number] => {\n  return [\n    Math.round(Math.max(point.x - bboxSize / 2, 0)),\n    Math.round(Math.max(point.y - bboxSize / 2, 0)),\n    Math.round(Math.min(point.x + bboxSize / 2, width)),\n    Math.round(Math.min(point.y + bboxSize / 2, height)),\n  ];\n};\nexport async function vlmPlanning(options: {\n  userInstruction: string;\n  conversationHistory: ChatCompletionMessageParam[];\n  size: { width: number; height: number };\n}): Promise<{\n  actions: PlanningAction<any>[];\n  realActions: ReturnType<typeof actionParser>['parsed'];\n  action_summary: string;\n}> {\n  const { conversationHistory, userInstruction, size } = options;\n  const systemPrompt = uiTarsPlanningPrompt + userInstruction;\n\n  const res = await call(\n    [\n      {\n        role: 'user',\n        content: systemPrompt,\n      },\n      ...conversationHistory,\n    ],\n    AIActionType.INSPECT_ELEMENT,\n  );\n  const { parsed } = actionParser({\n    prediction: res.content,\n    factor: 1000,\n  });\n  const transformActions: PlanningAction[] = [];\n  parsed.forEach((action) => {\n    if (action.action_type === 'click') {\n      assert(action.action_inputs.start_box, 'start_box is required');\n      const point = getPoint(action.action_inputs.start_box, size);\n      transformActions.push({\n        type: 'Locate',\n        param: {},\n        locate: {\n          prompt: action.thought || '',\n          bbox: pointToBbox(\n            { x: point[0], y: point[1] },\n            size.width,\n            size.height,\n          ),\n        },\n      });\n      transformActions.push({\n        type: 'Tap',\n        locate: {\n          prompt: action.thought || '',\n          bbox: pointToBbox(\n            { x: point[0], y: point[1] },\n            size.width,\n            size.height,\n          ),\n        },\n        param: action.thought || '',\n      });\n    } else if (action.action_type === 'drag') {\n      assert(action.action_inputs.start_box, 'start_box is required');\n      assert(action.action_inputs.end_box, 'end_box is required');\n      const startPoint = getPoint(action.action_inputs.start_box, size);\n      const endPoint = getPoint(action.action_inputs.end_box, size);\n      transformActions.push({\n        type: 'Drag',\n        param: {\n          start_box: { x: startPoint[0], y: startPoint[1] },\n          end_box: { x: endPoint[0], y: endPoint[1] },\n        },\n        locate: null,\n        thought: action.thought || '',\n      });\n    } else if (action.action_type === 'type') {\n      transformActions.push({\n        type: 'Input',\n        param: {\n          value: action.action_inputs.content,\n        },\n        locate: null,\n        thought: action.thought || '',\n      });\n    } else if (action.action_type === 'scroll') {\n      transformActions.push({\n        type: 'Scroll',\n        param: {\n          direction: action.action_inputs.direction,\n        },\n        locate: null,\n        thought: action.thought || '',\n      });\n    } else if (action.action_type === 'finished') {\n      transformActions.push({\n        type: 'Finished',\n        param: {},\n        locate: null,\n        thought: action.thought || '',\n      });\n    } else if (action.action_type === 'hotkey') {\n      assert(action.action_inputs.key, 'key is required');\n      const keys = transformHotkeyInput(action.action_inputs.key);\n\n      transformActions.push({\n        type: 'KeyboardPress',\n        param: {\n          value: keys,\n        },\n        locate: null,\n        thought: action.thought || '',\n      });\n    } else if (action.action_type === 'wait') {\n      transformActions.push({\n        type: 'Sleep',\n        param: {\n          timeMs: 1000,\n        },\n        locate: null,\n        thought: action.thought || '',\n      });\n    }\n  });\n\n  if (transformActions.length === 0) {\n    throw new Error(`No actions found, response: ${res.content}`, {\n      cause: {\n        prediction: res.content,\n        parsed,\n      },\n    });\n  }\n\n  return {\n    actions: transformActions,\n    realActions: parsed,\n    action_summary: getSummary(res.content),\n  };\n}\n\nfunction getPoint(startBox: string, size: { width: number; height: number }) {\n  const [x, y] = JSON.parse(startBox);\n  return [x * size.width, y * size.height];\n}\n\ninterface BaseAction {\n  action_type: ActionType;\n  action_inputs: Record<string, any>;\n  reflection: string | null;\n  thought: string | null;\n}\n\ninterface ClickAction extends BaseAction {\n  action_type: 'click';\n  action_inputs: {\n    start_box: string; // JSON string of [x, y] coordinates\n  };\n}\n\ninterface DragAction extends BaseAction {\n  action_type: 'drag';\n  action_inputs: {\n    start_box: string; // JSON string of [x, y] coordinates\n    end_box: string; // JSON string of [x, y] coordinates\n  };\n}\n\ninterface WaitAction extends BaseAction {\n  action_type: 'wait';\n  action_inputs: {\n    time: string; // JSON string of [x, y] coordinates\n  };\n}\n\ninterface TypeAction extends BaseAction {\n  action_type: 'type';\n  action_inputs: {\n    content: string;\n  };\n}\n\ninterface HotkeyAction extends BaseAction {\n  action_type: 'hotkey';\n  action_inputs: {\n    key: string;\n  };\n}\n\ninterface ScrollAction extends BaseAction {\n  action_type: 'scroll';\n  action_inputs: {\n    direction: 'up' | 'down';\n  };\n}\n\ninterface FinishedAction extends BaseAction {\n  action_type: 'finished';\n  action_inputs: Record<string, never>;\n}\n\nexport type Action =\n  | ClickAction\n  | DragAction\n  | TypeAction\n  | HotkeyAction\n  | ScrollAction\n  | FinishedAction\n  | WaitAction;\n"]}